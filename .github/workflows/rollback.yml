# TÃªn cá»§a quy trÃ¬nh
name: Rollback

# Äiá»u kiá»‡n kÃ­ch hoáº¡t
on:
  # Cho phÃ©p cháº¡y thá»§ cÃ´ng tá»« tab Actions
  workflow_dispatch:
    # ThÃªm cÃ¡c trÆ°á»ng nháº­p liá»‡u Ä‘á»ƒ ngÆ°á»i dÃ¹ng Ä‘iá»n vÃ o khi cháº¡y
    inputs:
      commit_sha:
        description: 'Nháº­p vÃ o mÃ£ commit SHA Ä‘áº§y Ä‘á»§ cá»§a phiÃªn báº£n muá»‘n rollback vá»'
        required: true
        type: string

jobs:
  ##########################################################
  # JOB: THá»°C HIá»†N ROLLBACK TRÃŠN VPS                       #
  ##########################################################
  rollback:
    runs-on: ubuntu-latest

    steps:
      - name: Display Rollback Information
        run: |
          echo "ğŸš¨ Starting rollback process..."
          echo "â¡ï¸ Target repository: ${{ github.repository }}"
          echo "ï¸ï¸Target commit SHA: ${{ github.event.inputs.commit_sha }}"

      - name: Deploy previous version to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # Di chuyá»ƒn tá»›i thÆ° má»¥c triá»ƒn khai
            cd ${{ secrets.DOCKER_DEPLOY_PATH }}

            # XÃ‚Y Dá»°NG Láº I TÃŠN IMAGE Äáº¦Y Äá»¦ Vá»šI TAG LÃ€ COMMIT SHA ÄÆ¯á»¢C NHáº¬P VÃ€O
            FULL_IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}:${{ github.event.inputs.commit_sha }}"

            # Ghi tÃªn image vÃ o file .env Ä‘á»ƒ docker-compose Ä‘á»c
            echo "DOCKER_IMAGE=${FULL_IMAGE_NAME}" > .env

            echo "Rolling back to image: ${FULL_IMAGE_NAME}"

            # ÄÄƒng nháº­p vÃ o Docker Hub trÃªn VPS
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login --username "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

            # KÃ©o (pull) phiÃªn báº£n image cÅ© Ä‘Ã£ chá»‰ Ä‘á»‹nh
            docker-compose pull

            # Khá»Ÿi Ä‘á»™ng láº¡i container vá»›i image cÅ©
            docker-compose up -d --remove-orphans --filter "until=24h"

            echo "âœ… Rollback completed successfully!"
